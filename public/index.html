<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Battle Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;
    
    // API URL - works both locally and when deployed
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api'
      : '/api';

    // Lucide icons
    const Users = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );

    const Trophy = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
      </svg>
    );

    const Clock = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
    );

    const Loader = () => (
      <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
      </svg>
    );

    const XCircle = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    );

    function QuizGame() {
      const [gameState, setGameState] = useState('login'); // login, waiting, playing, finished
      const [playerName, setPlayerName] = useState('');
      const [playerLevel, setPlayerLevel] = useState(1);
      const [playerId, setPlayerId] = useState(null);
      const [sessionId, setSessionId] = useState(null);
      const [questions, setQuestions] = useState([]);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [answers, setAnswers] = useState({});
      const [timeStarted, setTimeStarted] = useState(null);
      const [result, setResult] = useState(null);
      const [opponent, setOpponent] = useState(null);

      // Poll for match
      useEffect(() => {
        if (gameState === 'waiting' && playerId) {
          const interval = setInterval(async () => {
            try {
              const res = await fetch(`${API_URL}/match/status/${playerId}`);
              const data = await res.json();
              
              if (data.matched) {
                setSessionId(data.sessionId);
                setQuestions(data.questions);
                setOpponent(data.opponent);
                setGameState('playing');
                setTimeStarted(Date.now());
              }
            } catch (err) {
              console.error('Error checking match status:', err);
            }
          }, 2000);

          return () => clearInterval(interval);
        }
      }, [gameState, playerId]);

      const handleLogin = async () => {
        if (!playerName.trim()) {
          alert('Please enter your name');
          return;
        }

        try {
          const res = await fetch(`${API_URL}/player/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: playerName, level: playerLevel })
          });
          const data = await res.json();
          setPlayerId(data.playerId);
          setGameState('waiting');
          
          // Start matchmaking
          await fetch(`${API_URL}/match/find`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playerId: data.playerId, level: playerLevel })
          });
        } catch (err) {
          console.error('Error registering:', err);
          alert('Error connecting to server. Make sure backend is running!');
        }
      };

      const handleAnswer = async (questionId, answer) => {
        const timeTaken = Date.now() - timeStarted;
        setAnswers({ ...answers, [questionId]: { answer, timeTaken } });

        try {
          await fetch(`${API_URL}/game/answer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              sessionId,
              playerId,
              questionId,
              answer,
              timeTaken
            })
          });

          if (currentQuestion < questions.length - 1) {
            setCurrentQuestion(currentQuestion + 1);
            setTimeStarted(Date.now());
          } else {
            // Game finished - get results
            const res = await fetch(`${API_URL}/game/result/${sessionId}`);
            const data = await res.json();
            setResult(data);
            setGameState('finished');
          }
        } catch (err) {
          console.error('Error submitting answer:', err);
        }
      };

      const resetGame = () => {
        setGameState('login');
        setPlayerName('');
        setPlayerLevel(1);
        setPlayerId(null);
        setSessionId(null);
        setQuestions([]);
        setCurrentQuestion(0);
        setAnswers({});
        setResult(null);
        setOpponent(null);
      };

      // LOGIN SCREEN
      if (gameState === 'login') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-6">
                <div className="w-16 h-16 text-yellow-500 mx-auto mb-4"><Trophy /></div>
                <h1 className="text-3xl font-bold text-gray-800">Quiz Battle</h1>
                <p className="text-gray-600 mt-2">Challenge players at your level!</p>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Your Name
                  </label>
                  <input
                    type="text"
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                    placeholder="Enter your name"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Your Level
                  </label>
                  <select
                    value={playerLevel}
                    onChange={(e) => setPlayerLevel(Number(e.target.value))}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                  >
                    {[1, 2, 3, 4, 5].map(level => (
                      <option key={level} value={level}>Level {level}</option>
                    ))}
                  </select>
                </div>
                
                <button
                  onClick={handleLogin}
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                >
                  Find Match
                </button>
              </div>
            </div>
          </div>
        );
      }

      // WAITING FOR OPPONENT SCREEN
      if (gameState === 'waiting') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
              <div className="w-16 h-16 text-purple-600 mx-auto mb-4"><Loader /></div>
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Finding Opponent...</h2>
              <p className="text-gray-600">Searching for a Level {playerLevel} player</p>
              <div className="mt-6 flex items-center justify-center space-x-2">
                <div className="w-5 h-5 text-gray-400"><Users /></div>
                <span className="text-sm text-gray-500">Waiting for match</span>
              </div>
              <p className="text-xs text-gray-400 mt-4">
                Tip: Open this page in another browser window to test!
              </p>
            </div>
          </div>
        );
      }

      // PLAYING QUIZ SCREEN
      if (gameState === 'playing') {
        const question = questions[currentQuestion];
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-2xl shadow-2xl p-6 mb-4">
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center space-x-2">
                    <div className="w-5 h-5 text-purple-600"><Users /></div>
                    <span className="font-semibold">{playerName} vs {opponent}</span>
                  </div>
                  <div className="flex items-center space-x-2">
                    <div className="w-5 h-5 text-blue-600"><Clock /></div>
                    <span className="font-semibold">Question {currentQuestion + 1}/10</span>
                  </div>
                </div>
                
                <div className="w-full bg-gray-200 rounded-full h-2 mb-6">
                  <div
                    className="bg-purple-600 h-2 rounded-full transition-all"
                    style={{ width: `${((currentQuestion + 1) / 10) * 100}%` }}
                  />
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-6">
                  {question.question}
                </h2>
                
                <div className="grid gap-4">
                  {question.options.map((option, idx) => (
                    <button
                      key={idx}
                      onClick={() => handleAnswer(question.id, option)}
                      className="w-full text-left p-4 border-2 border-gray-300 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all font-medium text-gray-700"
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // RESULTS SCREEN
      if (gameState === 'finished' && result) {
        const isWinner = result.winner === playerId;
        
        // Determine which player's stats to show where
        const myStats = result.player1 === playerId ? result.player1Score : result.player2Score;
        const opponentStats = result.player1 === playerId ? result.player2Score : result.player1Score;
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl">
              <div className="text-center mb-6">
                {isWinner ? (
                  <div className="w-20 h-20 text-yellow-500 mx-auto mb-4"><Trophy /></div>
                ) : (
                  <div className="w-20 h-20 text-red-500 mx-auto mb-4"><XCircle /></div>
                )}
                <h2 className="text-3xl font-bold text-gray-800 mb-2">
                  {isWinner ? 'ðŸŽ‰ You Won!' : 'ðŸ˜” You Lost'}
                </h2>
                <p className="text-gray-600">
                  {isWinner ? 'Congratulations on your victory!' : 'Better luck next time!'}
                </p>
                
                {result.winReason === 'more_correct_answers' && (
                  <p className="text-sm text-purple-600 mt-2 font-semibold">
                    Won by answering more questions correctly!
                  </p>
                )}
                {result.winReason === 'faster_time' && (
                  <p className="text-sm text-purple-600 mt-2 font-semibold">
                    Won by being faster! (Same correct answers)
                  </p>
                )}
                {result.winReason === 'tie' && (
                  <p className="text-sm text-purple-600 mt-2 font-semibold">
                    Perfect tie - both players performed identically!
                  </p>
                )}
              </div>

              <div className="grid md:grid-cols-2 gap-4 mb-6">
                <div className={`p-4 rounded-lg ${isWinner ? 'bg-green-50 border-2 border-green-500' : 'bg-purple-50'}`}>
                  <h3 className={`font-semibold mb-2 ${isWinner ? 'text-green-800' : 'text-purple-800'}`}>
                    Your Stats {isWinner ? 'ðŸ‘‘' : ''}
                  </h3>
                  <p className="text-sm text-gray-600">
                    <span className="font-bold">Correct:</span> {myStats.correctAnswers}/10
                  </p>
                  <p className="text-sm text-gray-600">
                    <span className="font-bold">Total Time:</span> {(myStats.totalTime / 1000).toFixed(2)}s
                  </p>
                  <p className="text-sm text-gray-600">
                    <span className="font-bold">Avg Time:</span> {(myStats.averageTime / 1000).toFixed(2)}s per question
                  </p>
                </div>
                
                <div className={`p-4 rounded-lg ${!isWinner ? 'bg-green-50 border-2 border-green-500' : 'bg-blue-50'}`}>
                  <h3 className={`font-semibold mb-2 ${!isWinner ? 'text-green-800' : 'text-blue-800'}`}>
                    {opponent}'s Stats {!isWinner ? 'ðŸ‘‘' : ''}
                  </h3>
                  <p className="text-sm text-gray-600">
                    <span className="font-bold">Correct:</span> {opponentStats.correctAnswers}/10
                  </p>
                  <p className="text-sm text-gray-600">
                    <span className="font-bold">Total Time:</span> {(opponentStats.totalTime / 1000).toFixed(2)}s
                  </p>
                  <p className="text-sm text-gray-600">
                    <span className="font-bold">Avg Time:</span> {(opponentStats.averageTime / 1000).toFixed(2)}s per question
                  </p>
                </div>
              </div>

              <button
                onClick={resetGame}
                className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
              >
                Play Again
              </button>
            </div>
          </div>
        );
      }

      return null;
    }

    // Render the app
    const root = createRoot(document.getElementById('root'));
    root.render(<QuizGame />);
  </script>
</body>
</html>