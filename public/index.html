<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Battle - Enhanced Matchmaking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;
    
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api'
      : '/api';

    // Icons
    const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
    const Trophy = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
    const Clock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
    const Send = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
    const CheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
    const XCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>;
    const Loader = () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>;
    const Star = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
    const Target = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
    const Award = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>;

    function QuizGame() {
      const [gameState, setGameState] = useState('login');
      const [playerName, setPlayerName] = useState('');
      const [playerLevel, setPlayerLevel] = useState(1);
      const [playerId, setPlayerId] = useState(null);
      const [playerScore, setPlayerScore] = useState(0);
      const [nearbyPlayers, setNearbyPlayers] = useState([]);
      const [pendingRequests, setPendingRequests] = useState([]);
      const [sessionId, setSessionId] = useState(null);
      const [questions, setQuestions] = useState([]);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [timeStarted, setTimeStarted] = useState(null);
      const [result, setResult] = useState(null);
      const [opponent, setOpponent] = useState(null);

      // Poll for match status in LOBBY
      useEffect(() => {
        if (gameState === 'lobby' && playerId) {
          const interval = setInterval(async () => {
            try {
              // Get nearby players
              const playersRes = await fetch(`${API_URL}/match/nearby/${playerId}`);
              const playersData = await playersRes.json();
              setNearbyPlayers(playersData.players || []);

              // Get pending requests
              const reqRes = await fetch(`${API_URL}/match/requests/${playerId}`);
              const reqData = await reqRes.json();
              setPendingRequests(reqData.requests || []);

              // Check if match was accepted
              const statusRes = await fetch(`${API_URL}/match/status/${playerId}`);
              const statusData = await statusRes.json();
              
              if (statusData.matched) {
                console.log('Match accepted! Starting game...');
                setSessionId(statusData.sessionId);
                setQuestions(statusData.questions);
                setOpponent(statusData.opponent);
                setGameState('playing');
                setTimeStarted(Date.now());
              }
            } catch (err) {
              console.error('Error fetching data:', err);
            }
          }, 2000);

          return () => clearInterval(interval);
        }
      }, [gameState, playerId]);

      const handleLogin = async () => {
        if (!playerName.trim()) return alert('Please enter your name');
        try {
          const res = await fetch(`${API_URL}/player/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: playerName, level: playerLevel })
          });
          const data = await res.json();
          setPlayerId(data.playerId);
          setPlayerScore(data.score || 0);
          setGameState('lobby');
        } catch (err) {
          alert('Error connecting to server');
        }
      };

      const sendMatchRequest = async (targetId) => {
        try {
          await fetch(`${API_URL}/match/request`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fromId: playerId, toId: targetId })
          });
          alert('Match request sent! Wait for them to accept.');
        } catch (err) {
          console.error('Error:', err);
        }
      };

      const acceptMatchRequest = async (fromId) => {
        try {
          const res = await fetch(`${API_URL}/match/accept`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playerId, fromId })
          });
          const data = await res.json();
          
          console.log('Accepting match...', data);
          
          setSessionId(data.sessionId);
          setQuestions(data.questions);
          setOpponent(data.opponent);
          setGameState('playing');
          setTimeStarted(Date.now());
        } catch (err) {
          console.error('Error:', err);
        }
      };

      const declineMatchRequest = async (fromId) => {
        try {
          await fetch(`${API_URL}/match/decline`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playerId, fromId })
          });
        } catch (err) {
          console.error('Error:', err);
        }
      };

      const handleAnswer = async (questionId, answer) => {
        const timeTaken = Date.now() - timeStarted;
        
        try {
          await fetch(`${API_URL}/game/answer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, playerId, questionId, answer, timeTaken })
          });

          if (currentQuestion < questions.length - 1) {
            setCurrentQuestion(currentQuestion + 1);
            setTimeStarted(Date.now());
          } else {
            // All questions answered - wait for opponent to finish
            setTimeout(async () => {
              const res = await fetch(`${API_URL}/game/result/${sessionId}`);
              const data = await res.json();
              setResult(data);
              
              // Update player score
              const scoreRes = await fetch(`${API_URL}/player/${playerId}`);
              const scoreData = await scoreRes.json();
              setPlayerScore(scoreData.score || 0);
              
              setGameState('finished');
            }, 1000);
          }
        } catch (err) {
          console.error('Error:', err);
        }
      };

      const resetGame = () => {
        setGameState('lobby');
        setSessionId(null);
        setQuestions([]);
        setCurrentQuestion(0);
        setResult(null);
        setOpponent(null);
      };

      // Login Screen
      if (gameState === 'login') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-6">
                <div className="w-16 h-16 text-yellow-500 mx-auto mb-4"><Trophy /></div>
                <h1 className="text-3xl font-bold text-gray-800">Quiz Battle</h1>
                <p className="text-gray-600 mt-2">Challenge players near your skill level!</p>
              </div>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                  <input 
                    type="text" 
                    value={playerName} 
                    onChange={(e) => setPlayerName(e.target.value)} 
                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()} 
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" 
                    placeholder="Enter your name" 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Your Level</label>
                  <select 
                    value={playerLevel} 
                    onChange={(e) => setPlayerLevel(Number(e.target.value))} 
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                  >
                    {[1, 2, 3, 4, 5].map(level => 
                      <option key={level} value={level}>Level {level}</option>
                    )}
                  </select>
                </div>
                <button 
                  onClick={handleLogin} 
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                >
                  Enter Lobby
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Lobby Screen
      if (gameState === 'lobby') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
            <div className="max-w-6xl mx-auto">
              {/* Player Info */}
              <div className="bg-white rounded-2xl shadow-2xl p-6 mb-4">
                <div className="flex justify-between items-center">
                  <div>
                    <h2 className="text-2xl font-bold text-gray-800">Welcome, {playerName}!</h2>
                    <p className="text-gray-600">Level {playerLevel} â€¢ Score: {playerScore}</p>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Star className="w-5 h-5 text-yellow-500" />
                    <span className="font-semibold text-gray-700">{playerScore} pts</span>
                  </div>
                </div>
              </div>

              {/* Matchmaking Panels */}
              <div className="grid md:grid-cols-2 gap-4">
                {/* Pending Requests */}
                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <Send className="w-5 h-5 mr-2 text-blue-600" /> 
                    Match Requests ({pendingRequests.length})
                  </h3>
                  {pendingRequests.length === 0 ? (
                    <p className="text-gray-500 text-center py-8">No pending requests</p>
                  ) : (
                    <div className="space-y-3">
                      {pendingRequests.map((req) => (
                        <div key={req.fromId} className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                          <div>
                            <p className="font-semibold text-gray-800">{req.fromName}</p>
                            <p className="text-sm text-gray-600">Level {req.fromLevel} â€¢ Score: {req.fromScore}</p>
                          </div>
                          <div className="flex space-x-2">
                            <button 
                              onClick={() => acceptMatchRequest(req.fromId)} 
                              className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                            >
                              <CheckCircle className="w-5 h-5" />
                            </button>
                            <button 
                              onClick={() => declineMatchRequest(req.fromId)} 
                              className="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                            >
                              <XCircle className="w-5 h-5" />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Nearby Players */}
                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <Target className="w-5 h-5 mr-2 text-purple-600" /> 
                    Players Near Your Level ({nearbyPlayers.length})
                  </h3>
                  {nearbyPlayers.length === 0 ? (
                    <p className="text-gray-500 text-center py-8">No players available</p>
                  ) : (
                    <div className="space-y-3">
                      {nearbyPlayers.map((player) => (
                        <div key={player.id} className="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                          <div>
                            <p className="font-semibold text-gray-800">{player.name}</p>
                            <p className="text-sm text-gray-600">Level {player.level} â€¢ Score: {player.score}</p>
                          </div>
                          <button 
                            onClick={() => sendMatchRequest(player.id)} 
                            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center space-x-2"
                          >
                            <Send className="w-4 h-4" />
                            <span>Challenge</span>
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Game Screen
      if (gameState === 'playing') {
        const question = questions[currentQuestion];
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
            <div className="max-w-4xl mx-auto">
              {/* Game Header */}
              <div className="bg-white rounded-2xl shadow-2xl p-6 mb-4">
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center space-x-2">
                    <Users className="w-5 h-5 text-purple-600" />
                    <span className="font-semibold">{playerName} vs {opponent}</span>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Clock className="w-5 h-5 text-blue-600" />
                    <span className="font-semibold">Question {currentQuestion + 1}/10</span>
                  </div>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-purple-600 h-2 rounded-full transition-all" 
                    style={{ width: `${((currentQuestion + 1) / 10) * 100}%` }} 
                  />
                </div>
              </div>

              {/* Question */}
              <div className="bg-white rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-6">{question.question}</h2>
                <div className="grid gap-4">
                  {question.options.map((option, idx) => (
                    <button 
                      key={idx} 
                      onClick={() => handleAnswer(question.id, option)} 
                      className="w-full text-left p-4 border-2 border-gray-300 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all font-medium"
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Results Screen
      if (gameState === 'finished' && result) {
        const isWinner = result.winner === playerId;
        const myStats = result.player1 === playerId ? result.player1Score : result.player2Score;
        const opponentStats = result.player1 === playerId ? result.player2Score : result.player1Score;
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl">
              {/* Result Banner */}
              <div className={`text-center mb-6 p-6 rounded-xl ${isWinner ? 'bg-gradient-to-r from-yellow-400 to-yellow-600' : 'bg-gradient-to-r from-gray-400 to-gray-600'}`}>
                {isWinner ? 
                  <Trophy className="w-20 h-20 text-white mx-auto mb-4" /> : 
                  <XCircle className="w-20 h-20 text-white mx-auto mb-4" />
                }
                <h2 className="text-4xl font-bold text-white mb-2">
                  {isWinner ? 'ðŸŽ‰ VICTORY!' : 'ðŸ˜” DEFEAT'}
                </h2>
                <p className="text-white text-lg">
                  {isWinner ? 'You are the champion!' : 'Better luck next time!'}
                </p>
              </div>

              {/* Win Reason */}
              <div className="text-center mb-6">
                {result.winReason === 'more_correct_answers' && (
                  <div className="inline-flex items-center space-x-2 px-4 py-2 bg-purple-100 rounded-full">
                    <Award className="w-5 h-5 text-purple-600" />
                    <span className="font-semibold text-purple-800">Won by answering more questions correctly!</span>
                  </div>
                )}
                {result.winReason === 'faster_time' && (
                  <div className="inline-flex items-center space-x-2 px-4 py-2 bg-blue-100 rounded-full">
                    <Clock className="w-5 h-5 text-blue-600" />
                    <span className="font-semibold text-blue-800">Won by being faster! (Same correct answers)</span>
                  </div>
                )}
              </div>

              {/* Stats Comparison */}
              <div className="grid md:grid-cols-2 gap-6 mb-6">
                {/* Player Stats */}
                <div className={`p-6 rounded-xl ${isWinner ? 'bg-green-50 border-4 border-green-500' : 'bg-purple-50 border-2 border-purple-200'}`}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className={`text-xl font-bold ${isWinner ? 'text-green-800' : 'text-purple-800'}`}>
                      {playerName}
                    </h3>
                    {isWinner && <span className="text-3xl">ðŸ‘‘</span>}
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Correct Answers:</span>
                      <span className="font-bold text-lg">{myStats.correctAnswers}/10</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Total Time:</span>
                      <span className="font-bold">{(myStats.totalTime / 1000).toFixed(2)}s</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Avg Time/Q:</span>
                      <span className="font-bold">{(myStats.averageTime / 1000).toFixed(2)}s</span>
                    </div>
                    <div className="flex justify-between items-center pt-2 border-t">
                      <span className="text-gray-600">New Score:</span>
                      <span className="font-bold text-xl text-yellow-600">{playerScore} pts</span>
                    </div>
                  </div>
                </div>

                {/* Opponent Stats */}
                <div className={`p-6 rounded-xl ${!isWinner ? 'bg-green-50 border-4 border-green-500' : 'bg-blue-50 border-2 border-blue-200'}`}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className={`text-xl font-bold ${!isWinner ? 'text-green-800' : 'text-blue-800'}`}>
                      {opponent}
                    </h3>
                    {!isWinner && <span className="text-3xl">ðŸ‘‘</span>}
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Correct Answers:</span>
                      <span className="font-bold text-lg">{opponentStats.correctAnswers}/10</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Total Time:</span>
                      <span className="font-bold">{(opponentStats.totalTime / 1000).toFixed(2)}s</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Avg Time/Q:</span>
                      <span className="font-bold">{(opponentStats.averageTime / 1000).toFixed(2)}s</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="grid grid-cols-2 gap-4">
                <button 
                  onClick={resetGame} 
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                >
                  Back to Lobby
                </button>
                <button 
                  onClick={() => setGameState('login')} 
                  className="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors"
                >
                  Exit
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<QuizGame />);
  </script>
</body>
</html>
